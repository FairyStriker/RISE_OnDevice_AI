<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetson Smart AI ê´€ì œ ì„¼í„°</title>
    <style>
        /* === [ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë³€ìˆ˜] === */
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f6f9; --text: #333; --table-head: #ecf0f1; --danger: #e74c3c; }
        body { font-family: 'Pretendard', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .live-badge { background: #e74c3c; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; animation: pulse 2s infinite; }
        .btn-modal { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }

        /* ----------------------------------------------------------- */
        /* [ìˆ˜ì •] ì»¨í…Œì´ë„ˆ: ì˜¤ë¥¸ìª½ íŒ¨ë„ ë„ˆë¹„ë¥¼ 400pxë¡œ ì™„ì „íˆ ê³ ì • --- */
        /* ----------------------------------------------------------- */
        .container { 
            flex: 1; 
            display: grid; 
            grid-template-columns: 1fr 400px; /* --- ì˜¤ë¥¸ìª½ ë„ˆë¹„ ê³ ì • --- */
            gap: 20px; 
            padding: 20px; 
            height: calc(100vh - 80px); 
            box-sizing: border-box; 
        }
        /* ----------------------------------------------------------- */

        /* ----------------------------------------------------------- */
        /* [ìˆ˜ì •] ì˜ìƒ êµ¬ì—­: 16:9 ë¹„ìœ¨ ê³ ì • ë° ìœ„ì¹˜ ìƒë‹¨ ê³ ì • --- */
        /* ----------------------------------------------------------- */
        .video-section { 
            background: black; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            aspect-ratio: 16 / 9; /* --- ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ ê³ ì • --- */
            width: 100%; 
            align-self: start;   /* --- ë°ì´í„° ê¸¸ì´ì— ìƒê´€ì—†ì´ ìƒë‹¨ ê³ ì • --- */
        }
        /* ----------------------------------------------------------- */
        
        iframe { width: 100%; height: 100%; border: none; }

        /* ----------------------------------------------------------- */
        /* [ìˆ˜ì •] ë°ì´í„° íŒ¨ë„: ë„ˆë¹„ê°€ ë³€í•˜ì§€ ì•Šë„ë¡ ì„¤ì • --- */
        /* ----------------------------------------------------------- */
        .data-panel { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            min-width: 400px; /* --- ìµœì†Œ ë„ˆë¹„ ê°•ì œ ê³ ì • --- */
            height: 100%; 
            box-sizing: border-box;
            overflow: hidden;
        }
        /* ----------------------------------------------------------- */

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-box { background: var(--primary); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .info-label { font-size: 0.8rem; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.4rem; font-weight: 800; }
        .count-box { background: #f39c12; color: white; padding: 12px; border-radius: 10px; text-align: center; }
        
        /* [ìˆ˜ì •] í…Œì´ë¸”ì´ ê¸¸ì–´ì ¸ë„ íŒ¨ë„ ë†’ì´ë¥¼ ëš«ê³  ë‚˜ê°€ì§€ ì•Šê²Œ í•¨ --- */
        .table-container { 
            flex: 1; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            border-radius: 8px; 
        }
        /* ----------------------------------------------------------- */
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--table-head); padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; }

        /* === [ëª¨ë‹¬ ìŠ¤íƒ€ì¼] === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 950px; border-radius: 16px; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .modal-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; }
        .model-upload { border-left: 1px solid #eee; padding-left: 30px; }
        .model-item { padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .model-item.active { border: 2px solid var(--accent); background: #f0f7ff; }
        .badge { background: var(--accent); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; }
        button.action-btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-switch { background: white; border: 1px solid var(--accent); color: var(--accent); }
        .btn-delete { background: #fee; color: #e74c3c; border: 1px solid #e74c3c; }
        .btn-upload { background: #27ae60; color: white; width: 100%; padding: 12px; margin-top: 15px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <h1><span>ğŸ‘ï¸ Jetson Smart ê´€ì œ ì„¼í„°</span> <span class="live-badge">LIVE</span></h1>
        <button class="btn-modal" onclick="openModal()">âš™ï¸ ëª¨ë¸ ê´€ë¦¬ ë° ì„¤ì •</button>
    </header>

    <div class="container">
        <div class="video-section">
            <iframe src="http://localhost:8889/jetson_nano" scrolling="no"></iframe>
        </div>

        <div class="data-panel">
            <div class="status-grid">
                <div class="info-box" style="background: #34495e;">
                    <div class="info-label">JETSON TIME</div>
                    <div class="info-value" id="sys-time">--:--:--</div>
                </div>
                <div class="info-box">
                    <div class="info-label">REALTIME FPS</div>
                    <div class="info-value" id="fps-val">--</div>
                </div>
            </div>
            <div class="count-box">
                <div class="info-label">DETECTED OBJECTS</div>
                <div class="info-value" id="obj-count" style="font-size: 1.8rem;">0</div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>ì‹ ë¢°ë„</th><th>ì¢Œí‘œ</th></tr></thead>
                    <tbody id="obj-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modelModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¦ ëª¨ë¸ í†µí•© ê´€ë¦¬</h2>
                <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-grid">
                    <div class="model-management">
                        <h3>ğŸ“‚ ë“±ë¡ëœ ëª¨ë¸ ëª©ë¡</h3>
                        <div id="model-items"></div>
                    </div>
                    <div class="model-upload">
                        <h3>ğŸ“¤ ìƒˆ ëª¨ë¸ ë“±ë¡</h3>
                        <form id="upload-form">
                            <label style="display:block; margin: 10px 0 5px;">ëª¨ë¸ ë³„ì¹­</label>
                            <input type="text" name="model_name" style="width:100%; padding:8px; box-sizing:border-box;" required>
                            <label style="display:block; margin: 10px 0 5px;">ì„¤ëª…</label>
                            <input type="text" name="description" style="width:100%; padding:8px; box-sizing:border-box;" required>
                            <label style="display:block; margin: 10px 0 5px;">Config (.txt)</label>
                            <input type="file" name="config_file" accept=".txt" required>
                            <label style="display:block; margin: 10px 0 5px;">Engine (.engine)</label>
                            <input type="file" name="engine_file" accept=".engine" required>
                            <button type="submit" class="action-btn btn-upload">ì—…ë¡œë“œ ë° ì¦‰ì‹œ ì ìš©</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        setInterval(async () => {
            try {
                const res = await fetch('/dashboard/latest');
                const data = await res.json();
                if (data.timestamp) {
                    document.getElementById('sys-time').innerText = data.timestamp;
                    document.getElementById('fps-val').innerText = data.fps.toFixed(1);
                    document.getElementById('obj-count').innerText = data.objects.length;
                    const tbody = document.getElementById('obj-tbody');
                    tbody.innerHTML = data.objects.map(obj => 
                        `<tr><td>#${obj.id}</td><td>${(obj.confidence*100).toFixed(0)}%</td><td style="font-family:monospace;">[${obj.bbox}]</td></tr>`
                    ).join('') || '<tr><td colspan="3" style="text-align:center; padding:20px; color:#ccc;">ê°ì§€ ì—†ìŒ</td></tr>';
                }
            } catch (e) {}
        }, 500);

        function openModal() { document.getElementById('modelModal').style.display = 'flex'; loadModels(); }
        function closeModal() { document.getElementById('modelModal').style.display = 'none'; }

        async function loadModels() {
            const res = await fetch('/api/models');
            const data = await res.json();
            const container = document.getElementById('model-items');
            container.innerHTML = Object.keys(data.history).sort((a,b)=>b-a).map(ver => {
                const info = data.history[ver];
                const isActive = (parseInt(ver) === data.active_version);
                return `
                    <div class="model-item ${isActive ? 'active' : ''}">
                        <div>
                            <strong>v${ver} - ${info.model_name}</strong> ${isActive ? '<span class="badge">Active</span>' : ''}
                            <div style="font-size:0.8rem; color:#666; margin-top:4px;">${info.description}</div>
                        </div>
                        <div>
                            ${!isActive ? `<button class="action-btn btn-switch" onclick="switchModel(${ver})">ì„ íƒ</button>` : ''}
                            <button class="action-btn btn-delete" onclick="deleteModel(${ver})">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function switchModel(ver) { if(confirm(`v${ver} ëª¨ë¸ë¡œ ì „í™˜í• ê¹Œìš”?`)) { await fetch(`/api/activate/${ver}`, {method:'POST'}); loadModels(); } }
        async function deleteModel(ver) { if(confirm(`v${ver} ëª¨ë¸ì„ ì˜êµ¬ ì‚­ì œí• ê¹Œìš”?`)) { await fetch(`/api/models/${ver}`, {method:'DELETE'}); loadModels(); } }

        document.getElementById('upload-form').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/upload_model', { method: 'POST', body: new FormData(e.target) });
            e.target.reset(); loadModels();
        };
    </script>
</body>
</html>